{% extends "base.html" %}

{% block title %}Dashboard - Your Item Finder{% endblock %}

{% block content %}

<div class="w-full max-w-6xl mx-auto"> <header class="text-center mb-8"> <h1 class="text-4xl font-extrabold text-teal-700"> Welcome, {{ username }} ({{ current_role.capitalize() }}) </h1>

    {# --- üöÄ NEW CHANGE PASSWORD LINK üöÄ --- #}
    <div class="mt-2 flex justify-center space-x-4 text-sm">
        <span class="text-gray-500">Account Settings:</span>
        <a href="{{ url_for('change_password') }}" class="text-teal-600 hover:text-teal-800 font-semibold underline decoration-dotted">
            üîí Change Password
        </a>
    </div>

    <p class="mt-4 text-lg text-gray-600">
        Browse and manage reported lost & found items.
    </p>
    <a href="{{ url_for('add_item') }}"
       class="mt-4 inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-xl shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150">
        + Report Lost/Found Item
    </a>
</header>

{% if current_role == 'admin' and request.args.get('user_filter', 'all') != 'mine' %}
<div class="mb-6 p-4 bg-red-100 border border-red-400 rounded-xl text-center shadow-md">
    <p class="text-gray-700 mb-2 font-semibold">
        You are viewing the Public Dashboard. For moderation actions, use the dedicated Admin Moderation Board.
    </p>
    <a href="{{ url_for('dashboard', user_filter='all') }}"
        class="px-4 py-2 rounded-lg text-sm font-semibold text-blue-800 bg-blue-200 hover:bg-blue-300 transition duration-150">
        View All Public Items
    </a>
</div>
{% endif %}

<div class="mb-4 flex space-x-4 justify-center">
    {% set current_user_filter = request.args.get('user_filter', 'all') %}

    <a href="{{ url_for('dashboard', user_filter='all', status=request.args.get('status'), category=request.args.get('category'), search=request.args.get('search'), sort_by=request.args.get('sort_by')) }}"
        class="px-4 py-2 rounded-xl text-sm font-semibold transition duration-150
        {% if current_user_filter == 'all' %}
            bg-blue-600 text-white shadow-md
        {% else %}
            bg-white text-gray-700 border border-gray-300 hover:bg-gray-100
        {% endif %}">
        All Public Items
    </a>

    <a href="{{ url_for('dashboard', user_filter='mine', status=request.args.get('status'), category=request.args.get('category'), search=request.args.get('search'), sort_by=request.args.get('sort_by')) }}"
        class="px-4 py-2 rounded-xl text-sm font-semibold transition duration-150
        {% if current_user_filter == 'mine' %}
            bg-blue-600 text-white shadow-md
        {% else %}
            bg-white text-gray-700 border border-gray-300 hover:bg-gray-100
        {% endif %}">
        üë§ My Items ({{ username }})
    </a>

    {# üöÄ NEW PENDING ITEMS LINK FOR STANDARD USERS üöÄ #}
    {% if current_role == 'user' %}
    <a href="{{ url_for('my_pending') }}"
        class="px-4 py-2 rounded-xl text-sm font-semibold transition duration-150 bg-yellow-100 text-yellow-800 border border-yellow-400 hover:bg-yellow-200 shadow-sm">
        ‚è≥ My Pending Items
    </a>
    {% endif %}
</div>

<div class="mb-8 p-6 bg-gray-50 rounded-2xl shadow-inner border border-gray-200">
    <h3 class="text-xl font-bold text-gray-700 mb-4">üîç Filter & Sort Items</h3>
    <form method="GET" action="{{ url_for('dashboard') }}" class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
        <input type="hidden" name="user_filter" value="{{ current_user_filter }}">

        <div>
            <label for="filter_status" class="block text-sm font-medium text-gray-700 mb-1">Status:</label>
            <select id="filter_status" name="status" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-white text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">All Status</option>
                <option value="Lost" {% if request.args.get('status') == 'Lost' %}selected{% endif %}>Lost Items</option>
                <option value="Found" {% if request.args.get('status') == 'Found' %}selected{% endif %}>Found Items</option>
                <option value="Claimed" {% if request.args.get('status') == 'Claimed' %}selected{% endif %}>Claimed / Resolved</option>
            </select>
        </div>

        <div>
            <label for="filter_category" class="block text-sm font-medium text-gray-700 mb-1">Category:</label>
            <select id="filter_category" name="category" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-white text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">All Categories</option>
                <option value="Electronics" {% if request.args.get('category') == 'Electronics' %}selected{% endif %}>Electronics</option>
                <option value="Apparel" {% if request.args.get('category') == 'Apparel' %}selected{% endif %}>Apparel</option>
                <option value="Tools" {% if request.args.get('category') == 'Tools' %}selected{% endif %}>Tools</option>
                <option value="Documents" {% if request.args.get('category') == 'Documents' %}selected{% endif %}>Documents</option>
                <option value="Other" {% if request.args.get('category') == 'Other' %}selected{% endif %}>Other</option>
            </select>
        </div>

        <div>
            <label for="sort_by" class="block text-sm font-medium text-gray-700 mb-1">Sort by:</label>
            <select id="sort_by" name="sort_by" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-white text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="date_desc" {% if current_sort == 'date_desc' %}selected{% endif %}>Newest First (Default)</option>
                <option value="date_asc" {% if current_sort == 'date_asc' %}selected{% endif %}>Oldest First</option>
                <option value="name_asc" {% if current_sort == 'name_asc' %}selected{% endif %}>Name (A-Z)</option>
                <option value="name_desc" {% if current_sort == 'name_desc' %}selected{% endif %}>Name (Z-A)</option>
            </select>
        </div>

        <div class="md:col-span-2">
            <label for="filter_search" class="block text-sm font-medium text-gray-700 mb-1">Search by Name/Description:</label>
            <div class="flex space-x-2">
                <input type="text" id="filter_search" name="search" value="{{ request.args.get('search', '') }}" placeholder="e.g., 'blue wallet'" class="flex-grow px-3 py-2 border border-gray-300 rounded-lg bg-white text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button type="submit" class="px-4 py-2 border border-transparent rounded-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150">
                    Apply Filters
                </button>
                {% if request.args.get('status') or request.args.get('category') or request.args.get('search') or request.args.get('user_filter') %}
                <a href="{{ url_for('dashboard') }}" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 bg-white hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 transition duration-150">
                    Reset
                </a>
                {% endif %}
            </div>
        </div>
    </form>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    {% if items %}
        {% for item in items %}
        <div class="bg-white border-gray-100 shadow-lg rounded-xl hover:shadow-2xl transition duration-300 border overflow-hidden">
            <div class="p-5">
                <div class="flex justify-between items-start mb-3">
                    <h4 class="text-xl font-bold text-gray-900 line-clamp-1">{{ item.name }}</h4>

                    {# Status Badge Logic #}
                    {% if not item.is_approved %}
                        <span class="px-3 py-1 text-xs font-bold rounded-full text-yellow-800 bg-yellow-200">PENDING APPROVAL</span>
                    {% elif item.status == 'Lost' %}
                        <span class="px-3 py-1 text-xs font-semibold rounded-full text-red-800 bg-red-100">Lost Item</span>
                    {% elif item.status == 'Found' %}
                        <span class="px-3 py-1 text-xs font-semibold rounded-full text-green-800 bg-green-100">Found Item</span>
                    {% elif item.status == 'Claimed' %}
                        <span class="px-3 py-1 text-xs font-semibold rounded-full text-gray-800 bg-gray-200">Claimed</span>
                    {% else %}
                        <span class="px-3 py-1 text-xs font-semibold rounded-full text-blue-800 bg-blue-100">{{ item.status }}</span>
                    {% endif %}
                </div>

                <p class="text-sm text-gray-500 mb-4 line-clamp-2">{{ item.description or 'No description provided.' }}</p>

                <ul class="space-y-1 text-sm text-gray-600">
                    <li>Category: {{ item.category or 'N/A' }}</li>
                    <li>Date: {{ item.date_lost or 'N/A' }}</li>
                    <li>Reported By: 
                        {% if item.user_id == current_user_id %}
                            <span class="font-bold text-teal-600">You!</span>
                        {% else %}
                            {{ item.owner_username or 'Unknown' }}
                        {% endif %}
                    </li>
                </ul>

                <a href="{{ url_for('view_item', item_id=item.id) }}" class="mt-4 block text-center py-2 text-sm font-medium text-teal-600 border border-teal-600 rounded-lg hover:bg-teal-50 transition duration-150">
                    View Full Details
                </a>
            </div>
        </div>
        {% endfor %}
    {% else %}
    <div class="md:col-span-3 text-center py-12 bg-white rounded-xl shadow-lg border border-gray-100">
        <p class="text-xl text-gray-500">No items match the current filters.</p>
    </div>
    {% endif %}
</div>
</div> {% endblock %}